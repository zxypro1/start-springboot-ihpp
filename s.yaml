kind: Pipeline
# 流水线执行名称，需要全局唯一。如果流水线模板存在，则不能成功提交流水线执行
# 推荐使用commitID与时间戳构造唯一的名称
name: "p-<% .git.shortCommitId %>-<% .currentTimestampMs %>"
# 一些任意的描述信息
description: 'demo pipeline'
# 添加任意的labels，用于查询过滤
# 应用中心会在提交时也会添加其他labels
labels:
  myLabel: my-cicd-example
spec:
  context:
    data:
      appName: <% .appName %>
  # 本次执行使用的流水线模板
  # 可以选择已有的模板，也可以在配置文件中自定义
  # 这里的例子为引用下文
  templateName: mytemplate-<% .git.branch %>

---

# 修改流水线模板，应用中心会按照该配置，创建或更新对应的模板
kind: PipelineTemplate
# 流水线模板名称，需要全局唯一，如果流水线模板存在，则会更新已有模板
# 推荐使用Branch或MR关联的ID构造唯一的名称
name: mytemplate-<% .git.branch %>
# 一些任意的描述信息
description: 用于测试环境的流水线模板
# 添加任意的labels，用于查询过滤
# 应用中心会在提交时也会添加其他labels
labels:
  myLabel: my-cicd-example
spec:
  context:
    data:
      # 环境名称，推荐不同的环境使用不同的流水线模板
      envName: test
      deployFile: s.yaml
  # 要执行的任务，默认所有任务会一同尝试执行
  # 执行会满足runAfters引入的先后约束，任务必须在runAfters声明的任务执行完毕后才可以被执行
  # 用户可以使用此特性，达到DAG描述的效果
  tasks:
    # 构建前检查
    - context:
        data:
          dingdingNotification:
            enable: false
            message:
              text: {}
            skipOnSuccess: false
      taskTemplate: need-approval
      name: pre-check-approval
      runAfters:
        - name: pre-check-ucr9
    - name: fc-canary-4kn5
      context:
        data:
          displayName: 版本灰度asd
          enable: true
          steps:
            - plugin: "@serverless-cd/checkout"
            - plugin: "@serverless-cd/s-setup"
            - plugin: "@serverless-cd/fc-canary"
              inputs:
                serviceName: my-fc-service
                aliasName: dev
                regionId: cn-hangzhou
                canaryPercent: 50
      taskTemplate: serverless-runner-task
      runAfters:
        - name: fc-canary-cz0g
    - name: pre-check-ucr9
      context:
        data:
          displayName: 前置检查
          enable: true
          steps:
            - plugin: "@serverless-cd/checkout"
            - plguin: "@serverless-cd/s-setup"
            - run: s plan -t "${{ ctx.data.deployFile }}"
      taskTemplate: serverless-runner-task
      runAfters:
        - name: build-and-deploy-rhkf
    - name: build-and-deploy-ol6b
      context:
        data:
          displayName: 构建部署
          enable: true
          steps:
            - plugin: "@serverless-cd/checkout"
            - plugin: "@serverless-cd/s-setup"
            - run: s deploy -t "${{ ctx.data.deployFile }}" --use-local --assume-yes
                --skip-push
      taskTemplate: serverless-runner-task
      runAfters:
        - name: pre-check-ucr9
    - name: build-and-deploy-rhkf
      context:
        data:
          displayName: "构建部署123"
          enable: true
          steps:
            - plugin: "@serverless-cd/checkout"
            - plugin: "@serverless-cd/s-setup"
            - run: s deploy -t "${{ ctx.data.deployFile }}" --use-local --assume-yes
                --skip-push
      taskTemplate: serverless-runner-task
    - name: fc-canary-cz0g
      context:
        data:
          displayName: 版本灰度new
          enable: true
          steps:
            - plugin: "@serverless-cd/checkout"
            - plugin: "@serverless-cd/s-setup"
            - plugin: "@serverless-cd/fc-canary"
              inputs:
                serviceName: my-fc-service
                aliasName: dev
                regionId: cn-hangzhou
                canaryPercent: 50
      taskTemplate: serverless-runner-task
      runAfters:
        - name: build-and-deploy-rhkf
